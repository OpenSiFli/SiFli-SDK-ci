
# SCons and Kconfig Quick Start

SifliSDK provides an Env configuration tool, which already includes SCons and Python. Therefore, there is no need to install SCons on the Windows platform. SifliSDK adds some script libraries on top of SCons to simplify the project configuration for users.

## 1. Project File Structure

SCons uses SConscript and SConstruct files to organize the source code structure. Typically, a project has only one SConstruct file located in the root directory, but it may have multiple SConscript files. Generally, each subdirectory containing source code will have a corresponding SConscript file. Users can refer to _example\uart\project\ec-lbxxx_ to see the project file structure.

SifliSDK creates a file called _rtconfig.py_ for each project. Therefore, each project directory will contain the following three files: _rtconfig.py_, _SConstruct_, and _SConscript_, which control the project compilation. A project has only one _SConstruct_ file but may have multiple _SConscript_ files. The _SConscript_ file is the main organizer of the source code.

SifliSDK uses menuconfig to configure the project. Each project has a Kconfig file in the root directory, which serves as the starting point for configuration options. After configuration, _.config_ and _rtconfig.h_ files are generated in the project root directory, which are used by SCons scripts and C files respectively.

Most source code folders in SifliSDK also have _SConscript_ files. These files are "found" by the _SConscript_ file in the project root directory, which adds the corresponding source code defined by the macros in _.config/rtconfig.h_ to the compiler.

The first file executed in SCons compilation is _SConstruct_. The _SConstruct_ in the user's project can configure some project options. Together with the project configuration generated by the menuconfig tool (.config), the `SifliEnv()` function sets the default compilation options. If users need to override the compilation/linking options, they can modify the corresponding parameters in the `Environment()` function.

## 2. Menuconfig Tool

Kconfig files are the source files for various configuration interfaces. The system configuration interface is called using the `menuconfig` command with the env tool in the project directory. This interface is generated by reading the Kconfig file in the current project directory. The Kconfig file serves as the entry point for all configurations. Kconfig files from different directories can be included in the configuration interface, and the configuration tool generates the system configuration interface for developers by reading the Kconfig files from each directory, ultimately generating the RT-Thread system configuration file _rtconfig.h_.

Types: Each config menu item must have a type definition. There are four types of variables: bool, string, hex, and int.

Reverse dependencies: The `select` statement indicates reverse dependencies, meaning the current configuration option depends on another option being selected.

Default values: This represents the default value of the current configuration option.

After configuring with the above statements, the following macros will be generated in the _rtconfig.h_ file:

```c
#define ASIC 1
#define BSP_USING_EMPTY_ASSERT 1
```

- `menu` statement  The `menu` statement is used to generate a menu. A menu is defined using `menu` and `endmenu`, and it can contain many `config` statements. This is simple and won't be detailed further.

- `if/endif` statement  This is used to define conditional statements to decide whether to display a certain configuration option based on a flag.

- `menuconfig` statement  This represents a configuration option with a menu. The `menuconfig` statement is similar to the `config` statement, but it requires all sub-options to be displayed on separate lines. The `depends on` statement indicates a dependency on another configuration option.

- `choice/endchoice` statement  This groups multiple similar configuration options together for the user to choose from. The `prompt` statement gives a hint to be displayed as the title of a popup. Multiple options can be provided, but only one can be selected, similar to a radio button.

- `comment` statement  The `comment` statement appears at the top of the interface and is used to define informational messages.

- `source` statement  This is used to read Kconfig files from another file.

For more detailed configuration, refer to [](../app_note/menuconfig.md).

## 3. Basic Functions of SCons

You can compile the project directly by entering the `scons` command in the Env tool. By default, it uses the ARM CLANG compiler. The SifliSDK root directory contains a _set_env.bat_ file, which sets the compiler directory.

If you want to specify your own compiler, you can modify the commands in _set_env.bat_:

```batch
set RTT_CC = keil
set RTT_EXEC = C:/Keilv5
```

Scons command
This command not only compiles the project but also generates MDK/IAR/VS projects. Adding different parameters will result in different effects.

- The `-s` parameter will suppress printing of internal commands.
- The `-c` parameter will clean the build targets, temporary files, and object files.
- The `--target=XXX` parameter is used when using MDK/IAR for project development. If you modify _rtconfig.h_ to enable or disable certain components, you need to use this parameter to regenerate the corresponding customized project and then compile it in MDK/IAR.

```{warning}
Note: To generate MDK or IAR project files, the prerequisite is that the project directory contains a project template file. Only then will `scons` generate the relevant source code, header file search paths, compiler parameters, and linker parameters based on the template. The template file typically specifies which chip the project is for. Therefore, in most cases, the template file is an empty project file, used to assist _SCons_ in generating _project.uvprojx_ or _project.eww_. To make it easier for customers, if no _project.uvprojx_ is found, SiFliSDK will use a default template to generate _project.uvprojx_. If you don't want to use the default template (for example, if you want to add your own compilation options), you can copy the _template.uvprojx_ file from _SifliSDK\tools\build\template_ into your project directory as your own template and make the necessary changes.
```

- The `-jN` parameter enables multi-threaded compilation. On a multi-core machine, you can use this command to speed up the compilation. Generally, one CPU core can support two threads. On a dual-core machine, use `scons -j4`.
- The `--verbose` parameter is used to display the compilation parameters. By default, the output of the `scons` command does not show compilation parameters, but with this parameter, the compilation parameters will be displayed.

## 4. Built-in Functions of SCons

If you want to add some source code to the _SCons_ compilation environment, you can generally create or modify an existing _SConscript_ file.

The SConscript file controls the inclusion of source code files and allows you to specify the file's group (similar to the concept of groups in MDK/IAR IDEs).

SCons provides many built-in functions to help us quickly add source code. By using these functions in combination with simple Python statements, we can freely add or remove source code from the project. Below are some commonly used functions. In fact, each _SConscript_ file is a Python file.

- `GetCurrentDir()` function: Gets the current directory.
- `Glob('*.c')` function: Gets all C files in the current directory. You can modify the suffix in the parameter to match files of a specific type.
- `GetDepend(macro)` function: Defined in the script file in the tools directory, this function reads configuration information from the _rtconfig.h_ file. Its parameter is the macro name from _rtconfig.h_. If a macro is enabled in _rtconfig.h_, this function will return true; otherwise, it returns false.
- `Split(str)` function: Splits the string `str` into a list.
- `DefineGroup(name, src, depend, **parameters)` function: This is a method (function) extended from _SCons_. `DefineGroup` is used to define a component. A component can be a directory (including files or subdirectories) and also a group or folder in subsequent IDE project files. The parameters can include:

  - `LIBS=<some.lib>`: Links a specific library into the project.
  - `LIBPATH=<some path>`: Adds a library path for searching.
  - `LIBRARY=<some.lib>`: Compiles and links all source code in the group to generate a .lib file.
  - `INSTALL_PATH=<some path>`: Installs the generated .lib file to a specific directory.
  - `CCFLAGS=<more CC flags>`: Adds compiler options.
  - `CPPPATH=<some folder>`: Adds a C header file search directory.
  - `CPPDEFINES=<more macro>`: Adds C macro definitions.
  - `LINKFLAGS=<more link flags>`: Adds linker options.
  - `ASFLAGS=<more assembly flags>`: Adds assembly options.
